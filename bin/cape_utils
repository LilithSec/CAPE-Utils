#!/usr/bin/env perl

use CAPE::Utils;
use strict;
use warnings;
use Getopt::Long;
use JSON;

sub version {
	print "cape_utils v. 0.0.1\n";
}

sub help {
	&version;

	print '
-c <ini>     Config INI file.
             Default: /usr/local/etc/cape_utils.ini
';
}

# get the commandline options
my $help    = 0;
my $version = 0;
my $ini_file;
my $action;
my $count;
my $use_json;
my $where;
Getopt::Long::Configure('no_ignore_case');
Getopt::Long::Configure('bundling');
GetOptions(
	'version' => \$version,
	'v'       => \$version,
	'help'    => \$help,
	'h'       => \$help,
	'i=s'     => \$ini_file,
	'a=s'     => \$action,
	'C'       => \$count,
	'j'       => \$count,
	'w=s'     => \$where,
);

if ( !defined($action) ) {
	$action = 'pending';
}

# print version or help if requested
if ($help) {
	&help;
	exit 42;
}
if ($version) {
	&version;
	exit 42;
}

my $cape_utils = CAPE::Utils->new($ini_file);

if ( $action eq 'pending' ) {
	if ($count) {
		print $cape_utils->get_pending_count(where => $where);
	}
	else {
		print $cape_utils->get_pending_table(where => $where);
	}
	exit 0;
}

if ( $action eq 'running' ) {
	if ($count) {
		print $cape_utils->get_running_count(where => $where);
	}
	else {
		print $cape_utils->get_running_table(where => $where);
	}
	exit 0;
}

if ($action eq 'submit') {
	$cape_utils->submit(items=>\@ARGV);
}
